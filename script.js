// El contenido de tu archivo JSON (debe ser el mismo que usaste antes)
const quizData = [
  {
    "id": "m-175979055987361",
    "nombre": "Administracion de proyectos",
    "temas": [
      {
        "id": "t-1759791103271106",
        "nombre": "Otro (temas que no recuerdo pero estan en los modelos)",
        "preguntas": [
          {
            "id": "p-1759795980106803",
            "enunciado": "en un proyecto de sotware la relacion gente trabajo:",
            "opciones": [
              "Es una relacion lineal",
              "Es una relacion dependiente.",
              "Es una relacion independiente.",
              "Es una relacion con distribucion triangular",
              "Es una relacion no lineal"
            ],
            "correcta": 4
          },
          {
            "id": "p-1759796026438798",
            "enunciado": "Marque la opcion incorrecta sobre EDT (WBS)",
            "opciones": [
              "Consiste en dividir en componentes menores para facilitar la planificacion y control.",
              "Organigrama jerarquico del proyecto donde se subdivide el mismo en menores componentes.",
              "El nivel mas alto de cada division se llama paquede de trabajo.",
              "No define secuencia.",
              "El nivel mas bajo se denomina paquete de trabajo, generalmente se agrupan bajo \"Paquetes de control\"."
            ],
            "correcta": 2
          },
                    {
            "id": "p-1759796026438733",
            "enunciado": "Marque la opción correcta sobre EDT (Estructura de desglose de trabajo) (WBS)",
            "opciones": [
              "No define secuencia",
              "Organigrama jerárquico del proyecto donde se subdivide el mismo en menores componentes.",
              "El nivel mas alto de cada division se llama paquede de trabajo.",
              "Consiste en dividir en componentes menores para facilitar la planificación y control.",
              "El nivel mas bajo se denomina paquete de trabajo, generalmente se agrupan bajo \"Paquetes de control\"."
            ],
            "correcta": [1,0,3,4]
          },
          {
            "id": "p-1759796104821167",
            "enunciado": "Los tipos de dependencias entre tareas pueden ser:",
            "opciones": [
              "Mandatorias, discrecionales, transitorias e permanentes.",
              "Directas, Indirectas, externas e internas.",
              "Heredadas, Implicitas, externas e transitorias.",
              "Opcionales, discrecionales, externas e internas.",
              "Mandatorias, discrecionales, externas e internas."
            ],
            "correcta": 4
          }
        ]
      },
      {
        "id": "t-1759791860450899",
        "nombre": "Proceso, producto, modelo de ciclo de vida",
        "preguntas": [
          {
            "id": "p-1759795938610501",
            "enunciado": "Marque la opcion correcta sobre los MCV:",
            "opciones": [
              "El ciclo de vida en Cascada en divisible mientras que el Incremental y el Evolutivo no lo son.",
              "El ciclo de vida en evolutivo, al igual que el incremental, es divisible y con alcance bien definido.",
              "Todos los ciclos de vida con alcance bien definidos son divisibles.",
              "Los ciclos de vida que evolucionan a incrementos o de manera modular son facilmente divisibles.",
              "Todas las anteriores son correctas."
            ],
            "correcta": 3
          },
          {
            "id": "p-1759796288652443",
            "enunciado": "Los procesos y actividades para la gestion de proyectos minimizan la probabilidad de fracaso garantizando el éxito del proyecto",
            "opciones": [
              "Verdadero",
              "Falso",
              "",
              "",
              ""
            ],
            "correcta": 1
          },
          {
            "id": "p-1759796307475517",
            "enunciado": "Para la gestion de proyectos un proceso debe tener una salidad explicita bien definida, pero puede carecer de entradas",
            "opciones": [
              "Verdadero",
              "Falso",
              "",
              "",
              ""
            ],
            "correcta": 1
          },
          {
            "id": "p-1759796336750811",
            "enunciado": "En relacion con la metodologia para seleccionar el MCV visto en clase marque la opcion correcta:",
            "opciones": [
              "Para seleccionar un MCV de debe hacer el promedio del resultado de los MCV seleccionados",
              "El valor mas bajo es MCV recomendado para utilizar",
              "Se evaluan 20 criterios agrupados por 4 categorias",
              "Cada uno de los criterios se evalua por Bajo, Medio y Alto",
              "Ninguna de las anteriores es correcta."
            ],
            "correcta": 4
          },
          {
            "id": "p-1759796450811488",
            "enunciado": "Un marco de proceso me define las actividades esenciales con un proposito especifico que puedo utilizar dentro del ciclo de vida del proyecto, pero no me define ni obliga a utilizar herramientas,",
            "opciones": [
              "Verdadero",
              "Falso",
              "",
              "",
              ""
            ],
            "correcta": 0
          },
          {
            "id": "p-1759796608227543",
            "enunciado": "Son caracteristicas de un modelo de Proceso.",
            "opciones": [
              "Proporciona la estructura desde la que se puede establecer un desarrollo de software.",
              "Un pequeño numero de actividades estructurales se puede aplicar a todos los …",
              "Diferentes conjuntos de tareas permiten a las actividades estructurales adaptarse al … del proyecto y a los requisitos del equipo.",
              "Todas las anteriosres.",
              "ninguna de las anteriores"
            ],
            "correcta": 3
          }
        ]
      },
      {
        "id": "t-1759791869444749",
        "nombre": "gestion de proyectos",
        "preguntas": [
          {
            "id": "p-1759796215133631",
            "enunciado": "La diferencia de Fast Tracking con Crashing es:",
            "opciones": [
              "Fast trackin es acelerar los tiempos planificados de desarrollo, mientras que crasgin es cumplir las tareas acortando su duracin lo mas posible.",
              "Fast Tracking es agregar mas recursos al camino critico para reducir su duraicon, mientras que crashin es paralelizar las tareas del camino critico a fin de acelerar los tiempos del proyecto.",
              "Fast Tracking implica la paralelizacion de tareas del camino critico y Crashing es ajustar o incrementar los recursos mientras se comprimen los tiempos planificados siempre manteniendo el alcance original.",
              "Fast Traking y Crashin son lo mismo depende de como lo llama una u otra bibliografia.",
              "Fast Tracking es agregar mas recursos para permitir incrementar la holgura a fin de no afectar la fecha de finalizacion del proyecto, mientras que crashing es paralelizar las tareas a fin de acelerar los tiempos del proyecto y reducir esa fecha."
            ],
            "correcta": 2
          },
          {
            "id": "p-1759796265543359",
            "enunciado": "Selecciones la opcion mas adecuada. MS Project me permite asignar Calendarios a:",
            "opciones": [
              "Solamente por Proyecto",
              "Por Proyecto y por Recurso.",
              "Solamente por Recurso.",
              "Ninguna de las anteriores es correcta.",
              ""
            ],
            "correcta": 1
          }
        ]
      },
      {
        "id": "t-1759791878909701",
        "nombre": "Planificacion",
        "preguntas": [
          {
            "id": "p-1759796182060128",
            "enunciado": "La planificacion puede llevarse a cabo con:",
            "opciones": [
              "Fecha estimada o fecha resultante",
              "Fecha prefijada o fecha predecible.",
              "Fecha resultante o fecha estipulada.",
              "Todas las anteriores son correctas.",
              "Fecha resultante o fecha estimada por juicio experto"
            ],
            "correcta": 2
          },
          {
            "id": "p-175979650590677",
            "enunciado": "La definicion mas precisa de Camino Critico es *",
            "opciones": [
              "La sumatoria de las actividades que tienen holgura igual a 1",
              "Las actividades que tienen riesgo muy alto",
              "Las actividades que de demorarse, se posterga la fecha de fin de proyecto",
              "Conjunto de actividades que definen la duracion del proyecto",
              "Ninguna es correcta"
            ],
            "correcta": 2
          }
        ]
      },
      {
        "id": "t-1759791888209977",
        "nombre": "Scrum",
        "preguntas": [
          {
            "id": "p-1759796969775274",
            "enunciado": "Seleccione la opcion que mas se acerque a la definion de \"reunion de planificacion\" (planning meeting)",
            "opciones": [
              "Se realiza al inicio del proyecto y se estiman todos los PBI (historia de usuario) para luego distribuirlos en los sprints",
              "Se realiza al inicio de cada sprint donde se define que se va construir y como, y se define el incremento",
              "el scrum master selcciona que probables PBI (historias de usuario)se podrian construir y valida con el equipo",
              "El product owner selecciona que probables PBI (Historias de usuario) se podrian construir y valida con el equipo",
              "Ninguna de las anteriores es correcta"
            ],
            "correcta": 1
          },
          {
            "id": "p-1759796969772177",
            "enunciado": "marque los artefactos de scrum",
            "opciones": [
              "Product Backlog",
              "Sprint Backlog",
              "Sprint Planning",
              "Retrospective Meeting",
              "Development Backlog Item"
            ],
            "correcta": [0,1]
          }
        ]
      }
    ]
  }
];

// Llamada inicial para cargar el cuestionario
document.addEventListener('DOMContentLoaded', loadQuiz);

// --- Funciones de Carga y Renderizado ---

function loadQuiz() {
    const quizContainer = document.getElementById('quiz-container');
    quizContainer.innerHTML = ''; 

    quizData[0].temas.forEach(tema => {
        const temaDiv = document.createElement('div');
        temaDiv.className = 'tema-section';
        temaDiv.id = `tema-${tema.id}`;
        temaDiv.setAttribute('data-tema-id', tema.id); 

        const temaTitle = document.createElement('h2');
        temaTitle.className = 'tema-title';
        temaTitle.textContent = `${tema.nombre}`;
        temaDiv.appendChild(temaTitle);

        tema.preguntas.forEach(pregunta => {
            const preguntaCard = createQuestionCard(pregunta);
            temaDiv.appendChild(preguntaCard);
        });
        
        // Se elimina el botón de evaluación por tema y su contenedor de resultados.

        quizContainer.appendChild(temaDiv);
    });
}

/**
 * Crea la tarjeta HTML para una pregunta.
 * @param {object} pregunta - Objeto de la pregunta.
 */
function createQuestionCard(pregunta) {
    const card = document.createElement('div');
    card.className = 'question-card';
    card.id = `q-${pregunta.id}`; 

    const enunciado = document.createElement('div');
    enunciado.className = 'enunciado';
    enunciado.textContent = pregunta.enunciado;
    card.appendChild(enunciado);

    // Determinar si es radio (respuesta única) o checkbox (múltiples respuestas)
    const isMultipleChoice = Array.isArray(pregunta.correcta);
    const inputType = isMultipleChoice ? 'checkbox' : 'radio';
    
    pregunta.opciones.forEach((opcion, index) => {
        const label = document.createElement('label');
        label.className = 'opcion-label';
        
        const input = document.createElement('input');
        input.type = inputType;
        input.name = `q-${pregunta.id}`; 
        input.value = index; 
        input.setAttribute('data-question-id', pregunta.id);
        
        label.appendChild(input);
        label.appendChild(document.createTextNode(opcion));
        card.appendChild(label);
    });

    return card;
}

// --- Funciones de Evaluación ---

/**
 * Evalúa las respuestas de todas las preguntas del cuestionario y muestra resultados globales.
 */
function evaluateQuiz() {
    const allResults = evaluateAllQuestions();
    displayGlobalResults(allResults);
}

/**
 * Recorre todas las preguntas y evalúa la respuesta del usuario.
 * También aplica el marcado visual (highlightQuestion).
 * @returns {Array} Un array de objetos con el resultado de cada pregunta.
 */
function evaluateAllQuestions() {
    const allResults = [];

    quizData[0].temas.forEach(tema => {
        tema.preguntas.forEach(pregunta => {
            const isCorrect = checkQuestionAnswer(pregunta);
            allResults.push({
                id: pregunta.id,
                enunciado: pregunta.enunciado,
                isCorrect: isCorrect,
                tema: tema.nombre,
                temaId: tema.id
            });
            // MARCAR VISUALMENTE LA PREGUNTA
            highlightQuestion(pregunta.id, isCorrect);
        });
    });

    return allResults;
}

/**
 * Comprueba la respuesta del usuario para una pregunta.
 * (La lógica de radio/checkbox se mantiene igual)
 * @param {object} pregunta - Objeto de la pregunta a comprobar.
 * @returns {boolean} - true si la respuesta del usuario es correcta, false en caso contrario.
 */
function checkQuestionAnswer(pregunta) {
    const isMultipleChoice = Array.isArray(pregunta.correcta);
    const selectedInputs = Array.from(document.querySelectorAll(`input[name="q-${pregunta.id}"]:checked`));
    
    const userSelections = selectedInputs.map(input => parseInt(input.value));

    if (isMultipleChoice) {
        const correctAnswers = pregunta.correcta;
        
        if (userSelections.length !== correctAnswers.length) {
            return false;
        }
        
        const correctSet = new Set(correctAnswers);
        return userSelections.every(selection => correctSet.has(selection));
        
    } else {
        const correctAnswer = pregunta.correcta;
        return userSelections.length === 1 && userSelections[0] === correctAnswer;
    }
}

/**
 * Muestra el resumen global de resultados, incluyendo puntaje y cantidad de correctas.
 * @param {Array} allResults - Resultados de todas las preguntas.
 */
function displayGlobalResults(allResults) {
    const resultsContainer = document.getElementById('results-container');
    const totalQuestions = allResults.length;
    const correctAnswers = allResults.filter(r => r.isCorrect).length;
    // Puntuación: 1 punto por respuesta correcta
    const totalScore = correctAnswers; 
    
    resultsContainer.innerHTML = `
        <h2>Resultados Globales del Cuestionario</h2>
        <p>Puntuación Obtenida: <span class="result-correct">${totalScore}</span> puntos.</p>
        <p>Preguntas Correctas: <span class="result-correct">${correctAnswers}</span> de ${totalQuestions}</p>
        <p>Porcentaje de Acierto: ${((correctAnswers / totalQuestions) * 100).toFixed(2)}%</p>
        <hr>
    `;

    // Resumen por tema (aún útil para ver el desempeño por sección)
    const resultsByTema = allResults.reduce((acc, result) => {
        if (!acc[result.tema]) {
            acc[result.tema] = { total: 0, correct: 0 };
        }
        acc[result.tema].total++;
        if (result.isCorrect) {
            acc[result.tema].correct++;
        }
        return acc;
    }, {});

    resultsContainer.innerHTML += '<h3>Resumen por Tema:</h3>';
    for (const tema in resultsByTema) {
        const { total, correct } = resultsByTema[tema];
        resultsContainer.innerHTML += `
            <p>${tema}: <span class="result-correct">${correct}</span> de ${total} correctas.</p>
        `;
    }
}

/**
 * Resalta la tarjeta de la pregunta para indicar si fue correcta o incorrecta.
 */
function highlightQuestion(questionId, isCorrect) {
    const card = document.getElementById(`q-${questionId}`);
    if (card) {
        card.classList.remove('result-correct', 'result-incorrect');
        if (isCorrect) {
            card.classList.add('result-correct');
            card.style.borderLeftColor = '#28a745'; 
        } else {
            card.classList.add('result-incorrect');
            card.style.borderLeftColor = '#dc3545';
        }

        const allLabels = card.querySelectorAll('.opcion-label');
        const pregunta = quizData[0].temas.flatMap(t => t.preguntas).find(p => p.id === questionId);
        const correctAnswers = Array.isArray(pregunta.correcta) ? pregunta.correcta : [pregunta.correcta];
        
        allLabels.forEach((label, index) => {
            label.style.backgroundColor = ''; 
            label.style.fontWeight = 'normal';
            
            // Si la opción es correcta, la marcamos visualmente
            if (correctAnswers.includes(index)) {
                label.style.backgroundColor = 'rgba(40, 167, 69, 0.2)'; 
                label.style.fontWeight = 'bold';
            } else if (label.querySelector('input:checked')) {
                 // Si el usuario marcó una opción incorrecta
                label.style.backgroundColor = 'rgba(220, 53, 69, 0.2)'; 
                label.style.fontWeight = 'bold';
            }
        });
    }

}
